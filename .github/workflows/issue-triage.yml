name: Issue Triage

on:
  issues:
    types: [opened]
permissions:
  issues: write
jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Triage issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            
            // Function to remove HTML comments
            const removeComments = (text) => {
              return text.replace(/<!--[\s\S]*?-->/g, '');
            };
            
            // Remove all HTML comments from the body first
            const cleanBody = removeComments(body);
            
            // Check if the issue contains the template headers
            const hasTemplate =
              cleanBody.includes("Page URL") &&
              cleanBody.includes("What's wrong") &&
              cleanBody.includes("Suggested fix") &&
              cleanBody.includes("Additional context");
            
            if (!hasTemplate) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Thanks for opening this issue.

            We've received your request and someone from the Pieces team will take a look. It may take up to **2 business days** to receive a response.

            In the meantime, please make sure the following sections are filled out to help us investigate efficiently:
            - Page URL
            - What's wrong
            - Suggested fix (if applicable)
            - Additional context

            If you think of more details, feel free to edit the issue or add a comment. üôè`
              });
              return;
            }
            
            // Extract content after "What's wrong?" - match until next ### header or end
            const whatsWrongRegex = /###\s*What's wrong\?\s*\n([\s\S]*?)(?=###|$)/i;
            const whatsWrongMatch = cleanBody.match(whatsWrongRegex);
            const whatsWrongContent = whatsWrongMatch ? whatsWrongMatch[1].trim() : '';
            
            // Also check Additional context as a secondary indicator
            const additionalContextRegex = /###\s*Additional context\s*\n([\s\S]*?)$/i;
            const additionalContextMatch = cleanBody.match(additionalContextRegex);
            const additionalContextContent = additionalContextMatch ? additionalContextMatch[1].trim() : '';
            
            // Check if both critical sections are empty (ignoring whitespace)
            const whatsWrongIsEmpty = whatsWrongContent.replace(/\s+/g, '').length === 0;
            const additionalContextIsEmpty = additionalContextContent.replace(/\s+/g, '').length === 0;
            
            // Close if "What's wrong?" is empty (this is the most critical field)
            if (whatsWrongIsEmpty) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `This issue is missing the most critical information: **what's wrong**.

            Please describe the problem you're experiencing so we can help you effectively.

            This issue will be closed, but feel free to reopen it once you've added:
            - A clear description of the problem
            - What you expected to happen
            - What actually happened

            Thank you! üôè`
              });
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ["invalid", "needs-info"]
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: "closed"
              });
              return;
            }
            
            // Issue has content in "What's wrong?" - post welcome message
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Thanks for opening this issue.

            We've received your request and someone from the Pieces team will take a look. It may take up to **2 business days** to receive a response.

            In the meantime, please make sure the following sections are filled out to help us investigate efficiently:
            - Page URL
            - What's wrong
            - Suggested fix (if applicable)
            - Additional context

            If you think of more details, feel free to edit the issue or add a comment. üôè`
            });
