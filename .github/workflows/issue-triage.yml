name: Issue Triage

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Triage issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";

            // Normalize body for easier matching
            const normalized = body
              .toLowerCase()
              .replace(/\s+/g, " ")
              .trim();

            // Detect issues that only contain the template and no real content
            const looksEmpty =
              normalized.includes("### page url") &&
              normalized.includes("### what's wrong") &&
              normalized.includes("### suggested fix") &&
              normalized.includes("### additional context") &&
              !normalized.match(/what's wrong[\s\S]*[a-z0-9]/) &&
              !normalized.match(/suggested fix[\s\S]*[a-z0-9]/) &&
              !normalized.match(/additional context[\s\S]*[a-z0-9]/);

            if (looksEmpty) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `This issue doesn't follow our issue template and is missing critical information.

**What's missing:**
- Explanation of the problem
- Page or source details
- Additional context or supporting information

This often happens when issues are created automatically or without being fully filled out.

Please feel free to reopen this issue once the required details are added. Thank you. üôè`
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ["invalid", "question"]
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: "closed"
              });

              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Thanks for opening this issue.

We've received your request and someone from the Pieces team will take a look. It may take up to **2 business days** to receive a response.

In the meantime, please make sure the following sections are filled out to help us investigate efficiently:
- Page URL
- What's wrong
- Suggested fix (if applicable)
- Additional context

If you think of more details, feel free to edit the issue or add a comment. üôè`
            });
