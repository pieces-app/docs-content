name: Issue Triage

on:
  issues:
    types: [opened]
permissions:
  issues: write
jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Triage issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            
            // Normalize body for easier matching
            const normalized = body
              .toLowerCase()
              .replace(/\s+/g, " ")
              .trim();
            
            // Check if the issue contains the template headers
            const hasTemplate =
              normalized.includes("page url") &&
              normalized.includes("what's wrong") &&
              normalized.includes("suggested fix") &&
              normalized.includes("additional context");
            
            if (!hasTemplate) {
              // Issue doesn't use template at all - let it through
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Thanks for opening this issue.

            We've received your request and someone from the Pieces team will take a look. It may take up to **2 business days** to receive a response.

            In the meantime, please make sure the following sections are filled out to help us investigate efficiently:
            - Page URL
            - What's wrong
            - Suggested fix (if applicable)
            - Additional context

            If you think of more details, feel free to edit the issue or add a comment. üôè`
              });
              return;
            }
            
            // Extract content after each header
            const extractAfterHeader = (text, header) => {
              const regex = new RegExp(`${header}\\s*(.+?)(?=###|$)`, 's');
              const match = text.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const pageUrlContent = extractAfterHeader(body, '### Page URL');
            const whatsWrongContent = extractAfterHeader(body, "### What's wrong\\?");
            const suggestedFixContent = extractAfterHeader(body, '### Suggested fix \\(optional\\)');
            const additionalContextContent = extractAfterHeader(body, '### Additional context');
            
            // Check if any section has meaningful content (more than just whitespace/newlines)
            const hasContent = (content) => {
              return content.replace(/\s+/g, '').length > 0;
            };
            
            const hasPageUrl = hasContent(pageUrlContent);
            const hasWhatsWrong = hasContent(whatsWrongContent);
            const hasSuggestedFix = hasContent(suggestedFixContent);
            const hasAdditionalContext = hasContent(additionalContextContent);
            
            // Consider it empty if none of the required sections have content
            // (suggested fix is optional, so we don't require it)
            const looksEmpty = !hasPageUrl && !hasWhatsWrong && !hasAdditionalContext;
            
            if (looksEmpty) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `This issue doesn't follow our issue template and is missing critical information.

            **What's missing:**
            - Explanation of the problem
            - Page or source details
            - Additional context or supporting information

            This often happens when issues are created automatically or without being fully filled out.

            Please feel free to reopen this issue once the required details are added. Thank you. üôè`
              });
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ["invalid", "question"]
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: "closed"
              });
              return;
            }
            
            // Issue has content - post welcome message
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Thanks for opening this issue.

            We've received your request and someone from the Pieces team will take a look. It may take up to **2 business days** to receive a response.

            In the meantime, please make sure the following sections are filled out to help us investigate efficiently:
            - Page URL
            - What's wrong
            - Suggested fix (if applicable)
            - Additional context

            If you think of more details, feel free to edit the issue or add a comment. üôè`
            });
